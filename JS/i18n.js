const translations = {
    en: {
        "title.home": "Ethiopis - Home",
        "title.about": "Ethiopis - About",
        "title.register": "Ethiopis - Register",
        "title.login": "Ethiopis - Login",
        "title.age4_6": "Ethiopis - Age 4-6 Learning",
        "title.age7_9": "Ethiopis - Age 7-9 Learning",
        "title.age10_12": "Ethiopis - Age 10-12 Learning",
        "nav.home": "Home",
        "nav.about": "About",
        "nav.login": "Login",
        "nav.register": "Register",
        "nav.back": "Back",
        "nav.logout": "Logout",
        "home.welcome": "Welcome to Ethiopis",
        "home.tagline": "Your Kid's E-Learning Platform in Ethiopia.",
        "home.about_button": "About Us",
        "about.title": "About Ethiopis",
        "about.image_alt": "Ethiopis team working with children",
        "about.paragraph1": "Ethiopis is an e-learning platform designed to provide engaging and educational content for children aged 4-12 in Ethiopia. Our mission is to make learning fun and accessible, fostering a love for knowledge from an early age.",
        "about.paragraph2": "We offer a wide range of activities, including games, stories, and quizzes, tailored to different age groups. Our content is carefully curated to align with educational standards and promote cognitive development.",
        "footer.copyright": "© 2025 Ethiopis. All rights reserved.",
        "footer.learning_portal": "Learning Portal",
        "register.title": "Parent Registration",
        "register.subtitle": "Create an account to register your child for Ethiopis",
        "register.parent_info": "Parent Information",
        "register.parent_name": "Parent Full Name",
        "register.phone": "Phone Number",
        "register.phone_error": "Please enter a valid Ethiopian phone number (e.g. +251911223344, +251711223344, 0911223344 or 0711223344)",
        "register.phone_exists": "This phone number is already registered. Please login or use a different number.",
        "register.password": "Password",
        "register.password_error": "Password must be at least 5 characters",
        "register.confirm_password": "Confirm Password",
        "register.confirm_error": "Passwords do not match",
        "register.child_info": "Child Information",
        "register.child_name": "Child Full Name",
        "register.age_group": "Age Group",
        "register.age_4_6": "4-6",
        "register.age_preschool": "Preschool & Kindergarten",
        "register.age_7_9": "7-9",
        "register.age_lower": "Lower Primary",
        "register.age_10_12": "10-12",
        "register.age_upper": "Upper Primary",
        "register.submit": "Register My Child",
        "register.have_account": "Already have an account?",
        "register.login_link": "Login here",
        "register.success": "Registration successful! Redirecting to login...",
        "register.age_group_error": "Please select an age group for your child",
        "login.title": "Parent Login",
        "login.subtitle": "Access your account to manage your child's learning",
        "login.phone": "Phone Number",
        "login.phone_error": "Please enter a valid Ethiopian phone number (e.g. +251911223344, +251711223344, 0911223344 or 0711223344)",
        "login.password": "Password",
        "login.password_error": "Please enter your password",
        "login.submit": "Login",
        "login.no_account": "Don't have an account?",
        "login.register_link": "Register here",
        "login.success": "Login successful! Redirecting...",
        "login.registration_success": "Registration successful! Please login with your credentials.",
        "login.invalid_credentials": "Invalid phone number or password. Please try again.",
        "password.toggle": "Toggle password visibility",
        "language.toggle": "Toggle language",
        "language.change": "Language changed to English",
        "session.timeout": "Your session will expire in 2 minutes due to inactivity",
        "session.expired": "Session expired. Please login again.",
        "error.general": "An error occurred. Please try again.",
        "error.network": "Network error. Please check your connection."
    },
    am: {
        "title.home": "ኢትዮፒስ - ዋና ገጽ",
        "title.about": "ኢትዮፒስ - ስለ እኛ",
        "title.register": "ኢትዮፒስ - ምዝገባ",
        "title.login": "ኢትዮፒስ - ግባ",
        "title.age4_6": "ኢትዮፒስ - 4-6 ዓመት ትምህርት",
        "title.age7_9": "ኢትዮፒስ - 7-9 ዓመት ትምህርት",
        "title.age10_12": "ኢትዮፒስ - 10-12 ዓመት ትምህርት",
        "nav.home": "ዋና ገጽ",
        "nav.about": "ስለ እኛ",
        "nav.login": "ግባ",
        "nav.register": "ይመዝገቡ",
        "nav.back": "ተመለስ",
        "nav.logout": "ውጣ",
        "home.welcome": "ወደ ኢትዮፒስ እንኳን በደህና መጡ",
        "home.tagline": "የልጆችዎ የኤሌክትሮኒክ ትምህርት መድረክ በኢትዮጵያ",
        "home.about_button": "ስለ እኛ",
        "about.title": "ስለ ኢትዮፒስ",
        "about.image_alt": "የኢትዮፒስ ቡድን ከልጆች ጋር እየሰራ ነው",
        "about.paragraph1": "ኢትዮፒስ ለ4-12 ዓመት ልጆች በኢትዮጵያ አስደሳች እና ትምህርታዊ ይዘት ለማቅረብ የተሰራ የኤሌክትሮኒክ ትምህርት መድረክ ነው። ተልእኳችን ትምህርትን አስደሳች እና ተደራሽ ማድረግ እና ከትንሽ አካባቢ የዕውቀት ፍቅርን ማበረታታት ነው።",
        "about.paragraph2": "ለተለያዩ ዕድሜ ክፍሎች የተስተካከሉ ጨዋታዎች፣ ታሪኮች እና ፅንሰ-ሀሳቦችን ጨምሮ ሰፋ ያለ መርጃዎችን እናቀርባለን። ይዘታችን ከትምህርታዊ ደረጃዎች ጋር እንዲስማማ በጥንቃቄ ተዘጋጅቷል እና የእውቀት እድገትን ለማበረታታት ይታሰባል።",
        "footer.copyright": "© 2025 ኢትዮፒስ። ሁሉም መብቶች የተጠበቁ ናቸው።",
        "footer.learning_portal": "የትምህርት መድረክ",
        "register.title": "የወላጅ ምዝገባ",
        "register.subtitle": "ለኢትዮፒስ ልጅዎን ለመመዝገብ መለያ ይፍጠሩ",
        "register.parent_info": "የወላጅ መረጃ",
        "register.parent_name": "የወላጅ ሙሉ ስም",
        "register.phone": "ስልክ ቁጥር",
        "register.phone_error": "እባክዎ ትክክለኛ የኢትዮጵያ ስልክ ቁጥር ያስገቡ (ለምሳሌ +251911223344, +251711223344, 0911223344 ወይም 0711223344)",
        "register.phone_exists": "ይህ ስልክ ቁጥር ቀድሞውኑ ተመዝግቧል። እባክዎ ይግቡ ወይም ሌላ ቁጥር ይጠቀሙ።",
        "register.password": "የይለፍ ቃል",
        "register.password_error": "የይለፍ ቃሉ ቢያንስ 5 ቁልፍ ሊኖረው ይገባል",
        "register.confirm_password": "የይለፍ ቃል አረጋግጥ",
        "register.confirm_error": "የይለፍ ቃላቶች አንድ አይነት አይደሉም",
        "register.child_info": "የልጅ መረጃ",
        "register.child_name": "የልጅ ሙሉ ስም",
        "register.age_group": "ዕድሜ ክልል",
        "register.age_4_6": "4-6",
        "register.age_preschool": "ቅድመ ትምህርት ቤት እና ኪንደርጋርተን",
        "register.age_7_9": "7-9",
        "register.age_lower": "የመጀመሪያ ደረጃ",
        "register.age_10_12": "10-12",
        "register.age_upper": "የላይኛው ደረጃ",
        "register.submit": "ልጄን ይመዝገቡ",
        "register.have_account": "ቀድሞውኑ መለያ አለዎት?",
        "register.login_link": "እዚህ ግባ",
        "register.success": "ምዝገባው በተሳካ ሁኔታ ተጠናቅቋል! ወደ መግቢያ በመቀጠል ላይ...",
        "register.age_group_error": "እባክዎ ለልጅዎ ዕድሜ ክልል ይምረጡ",
        "login.title": "የወላጅ መግቢያ",
        "login.subtitle": "የልጅዎን ትምህርት ለመቆጣጠር ወደ መለያዎ ይግቡ",
        "login.phone": "ስልክ ቁጥር",
        "login.phone_error": "እባክዎ ትክክለኛ የኢትዮጵያ ስልክ ቁጥር ያስገቡ (ለምሳሌ +251911223344, +251711223344, 0911223344 ወይም 0711223344)",
        "login.password": "የይለፍ ቃል",
        "login.password_error": "እባክዎ የይለፍ ቃልዎን ያስገቡ",
        "login.submit": "ግባ",
        "login.no_account": "መለያ የሎትም?",
        "login.register_link": "እዚህ ይግቡ",
        "login.success": "በተሳካ ሁኔታ ገብተዋል! እየተዛወርን ነው...",
        "login.registration_success": "ምዝገባው ተጠናቅቋል! እባክዎ ይግቡ።",
        "login.invalid_credentials": "ስልክ ቁጥር ወይም ይለፍ ቃል የተሳሳተ ነው። እባክዎ እንደገና ይሞክሩ።",
        "password.toggle": "የይለፍ ቃል ብልህነት ቀይር",
        "language.toggle": "ቋንቋ ቀይር",
        "language.change": "ቋንቋ ወደ አማርኛ ተቀይሯል",
        "session.timeout": "ምንም እንቅስቃሴ በማይኖርበት ሁኔታ ከ2 ደቂቃ በኋላ ክፍተትዎ ይቋረጣል",
        "session.expired": "ክፍተትዎ ጊዜው አልቋል። እባክዎ እንደገና ይግቡ።",
        "error.general": "ስህተት ተከስቷል። እባክዎ እንደገና ይግቡ",
        "error.network": "የኔትወርክ ስህተት። እባክዎ ግንኙነትዎን ያረጋግጡ።"
    }
};

let currentLanguage = 'en';
let inactivityTimer;
const SESSION_TIMEOUT = 15 * 60 * 1000; // 15 minutes
const WARNING_TIMEOUT = 13 * 60 * 1000; // Show warning at 13 minutes

// Initialize language and other features
document.addEventListener('DOMContentLoaded', () => {
    initializeLanguage();
    setupSessionTimeout();
    setupPasswordVisibilityToggle();
    setupAccessibilityFeatures();
});

function setupAccessibilityFeatures() {
    // Add aria-labels to interactive elements
    document.querySelectorAll('button, a, input').forEach(element => {
        if (!element.hasAttribute('aria-label')) {
            const text = element.textContent.trim() || element.getAttribute('placeholder') || '';
            if (text) {
                element.setAttribute('aria-label', text);
            }
        }
    });

    // Add focus styles for keyboard navigation
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
            document.body.classList.add('keyboard-navigation');
        }
    });

    document.addEventListener('mousedown', () => {
        document.body.classList.remove('keyboard-navigation');
    });
}

function setupPasswordVisibilityToggle() {
    const passwordFields = document.querySelectorAll('input[type="password"]');
    
    passwordFields.forEach(passwordField => {
        const wrapper = document.createElement('div');
        wrapper.className = 'password-wrapper';
        wrapper.style.position = 'relative';
        
        passwordField.parentNode.insertBefore(wrapper, passwordField);
        wrapper.appendChild(passwordField);
        
        const eyeIcon = document.createElement('button');
        eyeIcon.className = 'password-toggle';
        eyeIcon.type = 'button';
        eyeIcon.innerHTML = '👁️';
        eyeIcon.setAttribute('aria-label', translations[currentLanguage]['password.toggle'] || 'Toggle password visibility');
        eyeIcon.style.position = 'absolute';
        eyeIcon.style.right = '10px';
        eyeIcon.style.top = '50%';
        eyeIcon.style.transform = 'translateY(-50%)';
        eyeIcon.style.cursor = 'pointer';
        eyeIcon.style.userSelect = 'none';
        eyeIcon.style.background = 'none';
        eyeIcon.style.border = 'none';
        eyeIcon.style.padding = '0';
        
        wrapper.appendChild(eyeIcon);
        
        eyeIcon.addEventListener('click', () => {
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                eyeIcon.innerHTML = '👁️‍🗨️';
                eyeIcon.setAttribute('aria-pressed', 'true');
            } else {
                passwordField.type = 'password';
                eyeIcon.innerHTML = '👁️';
                eyeIcon.setAttribute('aria-pressed', 'false');
            }
        });
    });
}

function initializeLanguage() {
    const savedLanguage = localStorage.getItem('preferredLanguage');
    const browserLanguage = navigator.language.split('-')[0];
    
    currentLanguage = savedLanguage || 
                     (translations[browserLanguage] ? browserLanguage : 'en');
    
    updatePageText();
    
    const toggleButtons = document.querySelectorAll('.language-toggle');
    toggleButtons.forEach(button => {
        button.addEventListener('click', toggleLanguage);
        button.setAttribute('aria-label', translations[currentLanguage]['language.toggle'] || 'Toggle language');
    });
}

function updatePageText() {
    const elements = document.querySelectorAll('[data-i18n]');
    
    elements.forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[currentLanguage][key]) {
            if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                element.placeholder = translations[currentLanguage][key];
                if (!element.id.includes('password')) {
                    element.setAttribute('aria-label', translations[currentLanguage][key]);
                }
            } else if (element.tagName === 'IMG' && element.hasAttribute('alt')) {
                element.alt = translations[currentLanguage][key];
            } else {
                element.textContent = translations[currentLanguage][key];
            }
        } else {
            console.warn(`Missing translation for key: ${key} in language: ${currentLanguage}`);
        }
    });
    
    // Update the language toggle button text
    const toggleButtons = document.querySelectorAll('.language-toggle');
    toggleButtons.forEach(button => {
        button.textContent = currentLanguage === 'en' ? 'EN | አማ' : 'አማ | EN';
        button.setAttribute('aria-label', translations[currentLanguage]['language.toggle'] || 'Toggle language');
    });
    
    // Special handling for age group pages
    if (window.location.pathname.includes('age-')) {
        const ageGroup = window.location.pathname.split('-')[1].split('.')[0];
        document.title = translations[currentLanguage][`title.age${ageGroup.replace('_', '')}`] || document.title;
    }
}

function toggleLanguage() {
    currentLanguage = currentLanguage === 'en' ? 'am' : 'en';
    localStorage.setItem('preferredLanguage', currentLanguage);
    
    showNotification(translations[currentLanguage]['language.change']);
    
    // Smooth transition effect
    document.body.style.opacity = '0';
    setTimeout(() => {
        updatePageText();
        document.body.style.opacity = '1';
    }, 150);
    
    resetInactivityTimer();
}

function setupSessionTimeout() {
    const events = ['mousemove', 'keypress', 'scroll', 'click', 'touchstart', 'mousedown'];
    events.forEach(event => {
        document.addEventListener(event, resetInactivityTimer);
    });
    
    resetInactivityTimer();
}

function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    
    inactivityTimer = setTimeout(() => {
        showNotification(translations[currentLanguage]['session.timeout'], 'warning');
    }, WARNING_TIMEOUT);
    
    inactivityTimer = setTimeout(() => {
        showNotification(translations[currentLanguage]['session.expired'], 'error');
        // In a real app, you would redirect to login:
        // window.location.href = 'login.html?session_expired=true';
    }, SESSION_TIMEOUT);
}

function showNotification(message, type = 'info', duration = 3000) {
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.setAttribute('role', 'alert');
    notification.setAttribute('aria-live', 'polite');
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, duration);
}

function addNotificationStyles() {
    const style = document.createElement('style');
    style.textContent = `
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            max-width: 90%;
            text-align: center;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }
        
        .notification-info {
            background-color: var(--primary-color);
        }
        
        .notification-success {
            background-color: #2ecc71;
        }
        
        .notification-warning {
            background-color: #f39c12;
        }
        
        .notification-error {
            background-color: #e74c3c;
        }
        
        .password-wrapper {
            position: relative;
            width: 100%;
        }
        
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            user-select: none;
            font-size: 1.2em;
            background: none;
            border: none;
            padding: 0;
        }
        
        input[type="password"], 
        input[type="text"] {
            padding-right: 40px !important;
            width: 100%;
        }
        
        /* Accessibility improvements */
        .keyboard-navigation *:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    `;
    document.head.appendChild(style);
}

// Add styles when script loads
if (!document.querySelector('style[data-i18n-styles]')) {
    addNotificationStyles();
}

// Export for use in other modules if needed
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        translations,
        currentLanguage,
        toggleLanguage
    };
}